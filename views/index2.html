<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prueba de Llamadas ElevenLabs - Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <!-- React, React DOM & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      function App() {
        const [userName, setUserName] = useState('');
        const [toNumber, setToNumber] = useState('');
        const [response, setResponse] = useState(null);
        const [logs, setLogs] = useState([]);
        const [chatMessages, setChatMessages] = useState([]);
        const [isConnected, setIsConnected] = useState(false);
        const [isLoading, setIsLoading] = useState(false);
        const audioContext = useRef(null);

        // Función para reproducir audio desde base64
        const playAudio = async (base64Audio) => {
          if (!audioContext.current) {
            audioContext.current = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          const audioData = atob(base64Audio);
          const arrayBuffer = new ArrayBuffer(audioData.length);
          const view = new Uint8Array(arrayBuffer);
          for (let i = 0; i < audioData.length; i++) {
            view[i] = audioData.charCodeAt(i);
          }
          
          try {
            const audioBuffer = await audioContext.current.decodeAudioData(arrayBuffer);
            const source = audioContext.current.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.current.destination);
            source.start(0);
          } catch (error) {
            console.error('Error reproduciendo audio:', error);
          }
        };
        
        const logsRef = useRef(null);
        const chatRef = useRef(null);
        const wsRef = useRef(null);
        
        useEffect(() => {
          // Conectar al WebSocket para logs
          connectWebSocket();
          
          // Limpieza al desmontar
          return () => {
            if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
              wsRef.current.close();
            }
          };
        }, []);
        
        useEffect(() => {
          // Auto-scroll de logs
          if (logsRef.current) {
            logsRef.current.scrollTop = logsRef.current.scrollHeight;
          }
        }, [logs]);
        
        useEffect(() => {
          // Auto-scroll de chat
          if (chatRef.current) {
            chatRef.current.scrollTop = chatRef.current.scrollHeight;
          }
        }, [chatMessages]);
        
        const connectWebSocket = () => {
          // Construir la URL WebSocket
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/logs-websocket`;
          
          wsRef.current = new WebSocket(wsUrl);
          
          wsRef.current.onopen = () => {
            setIsConnected(true);
            addLog("[INFO] Conexión WebSocket establecida");
          };
          
          wsRef.current.onmessage = (event) => {
            const message = event.data;
            addLog(message);
            
            try {
              // Intentar parsear el mensaje como JSON
              const jsonMessage = JSON.parse(message);
              
              // Si es un mensaje de audio
              if (jsonMessage.type === 'audio') {
                if (jsonMessage.source === 'elevenlabs' && jsonMessage.audio) {
                  // Reproducir audio del bot
                  playAudio(jsonMessage.audio);
                } else if (jsonMessage.source === 'client' && jsonMessage.audio) {
                  // Reproducir audio del cliente
                  playAudio(jsonMessage.audio);
                }
              }
            } catch (e) {
              // Si no es JSON, procesar como mensaje de texto normal
              if (message.includes("[Twilio] Respuesta del agente:")) {
                const agentMessage = message.split("[Twilio] Respuesta del agente:")[1].trim();
                addChatMessage(agentMessage, 'server');
              } else if (message.includes("[Twilio] Transcripción del usuario:")) {
                const userMessage = message.split("[Twilio] Transcripción del usuario:")[1].trim();
                addChatMessage(userMessage, 'client');
              }
            }
          };
          
          wsRef.current.onclose = () => {
            setIsConnected(false);
            addLog("[INFO] Conexión WebSocket cerrada");
            
            // Reconectar después de 3 segundos
            setTimeout(connectWebSocket, 3000);
          };
          
          wsRef.current.onerror = (error) => {
            setIsConnected(false);
            addLog("[ERROR] Error en WebSocket");
            console.error("WebSocket error:", error);
          };
          
          // Enviar heartbeat cada 30 segundos
          const heartbeatInterval = setInterval(() => {
            if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
              wsRef.current.send("heartbeat");
            }
          }, 30000);
          
          return () => clearInterval(heartbeatInterval);
        };
        
        const addLog = (message) => {
          setLogs(prevLogs => [...prevLogs, message]);
        };
        
        const addChatMessage = (content, type) => {
          setChatMessages(prev => [...prev, { content, type }]);
        };
        
        const handleSubmit = async (e) => {
          e.preventDefault();
          setIsLoading(true);
          
          try {
            const response = await fetch('/outbound-call', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                nombre: userName,
                to_number: toNumber || undefined
              })
            });
            
            const data = await response.json();
            setResponse(data);
            
            if (data.success) {
              addLog(`[INFO] Llamada iniciada con éxito: ${data.call_sid}`);
            } else {
              addLog(`[ERROR] Error al iniciar llamada: ${data.error}`);
            }
          } catch (error) {
            console.error("Error:", error);
            addLog(`[ERROR] Error al realizar la petición: ${error.message}`);
          } finally {
            setIsLoading(false);
          }
        };
        
        return (
          <div className="max-w-4xl mx-auto p-6">
            <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl p-8 mb-8 shadow-lg">
              <h1 className="text-3xl font-bold text-center flex items-center justify-center gap-2">
                <i className="fas fa-phone-alt"></i>
                ElevenLabs - Prueba de Llamadas
              </h1>
              <p className="text-center mt-2 opacity-90">Sistema de pruebas de llamadas automatizadas con IA</p>
            </div>

            <div className="mb-6">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                  <span className="text-gray-600 text-sm">
                    {isConnected ? 'Servidor conectado' : 'Servidor desconectado'}
                  </span>
                </div>
                <div className="text-sm">
                  <strong>URL pública:</strong> <span>{"{publicUrl}"}</span>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow p-6 mb-8">
              <h5 className="text-xl font-semibold mb-4 flex items-center gap-2">
                <i className="fas fa-headset"></i>
                Nueva llamada
              </h5>

              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-gray-700 mb-2" htmlFor="userName">
                    <i className="fas fa-user mr-2"></i>
                    Nombre de la persona a llamar:
                  </label>
                  <input 
                    type="text" 
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    id="userName" 
                    placeholder="Ingrese el nombre" 
                    value={userName}
                    onChange={(e) => setUserName(e.target.value)}
                    required
                  />
                </div>

                <div>
                  <label className="block text-gray-700 mb-2" htmlFor="toNumber">
                    <i className="fas fa-phone mr-2"></i>
                    Número de teléfono (opcional):
                  </label>
                  <input 
                    type="text" 
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    id="toNumber" 
                    placeholder="+541161728140" 
                    value={toNumber}
                    onChange={(e) => setToNumber(e.target.value)}
                  />
                  <p className="text-sm text-gray-500 mt-1">
                    Se usará el número predeterminado si está vacío.
                  </p>
                </div>

                <button 
                  type="submit" 
                  className={`w-full py-3 px-4 rounded-lg text-white font-medium ${
                    isLoading 
                      ? 'bg-gray-400 cursor-not-allowed' 
                      : 'bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700'
                  } transition-colors`}
                  disabled={isLoading}
                >
                  {isLoading ? (
                    <div className="flex items-center justify-center gap-2">
                      <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                      Iniciando llamada...
                    </div>
                  ) : (
                    <div className="flex items-center justify-center gap-2">
                      <i className="fas fa-phone-alt"></i>
                      Iniciar Llamada
                    </div>
                  )}
                </button>
              </form>
            </div>

            {response && (
              <div className={`mb-8 p-4 rounded-lg ${response.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                {response.success ? (
                  <div className="flex items-center gap-2">
                    <i className="fas fa-check-circle"></i>
                    <span>Llamada iniciada con éxito {response.call_sid ? `(SID: ${response.call_sid})` : ''}</span>
                  </div>
                ) : (
                  <div className="flex items-center gap-2">
                    <i className="fas fa-exclamation-triangle"></i>
                    <span>Error: {response.error}</span>
                  </div>
                )}
              </div>
            )}

            <h3 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <i className="fas fa-comments"></i>
              Conversación Transcripta
            </h3>
            <div className="bg-gray-100 rounded-xl p-4 h-72 overflow-y-auto mb-8" ref={chatRef}>
              {chatMessages.length === 0 ? (
                <div className="text-center text-gray-500 py-8">
                  <i className="fas fa-comment-slash text-4xl mb-3"></i>
                  <p>No hay mensajes en la conversación</p>
                </div>
              ) : (
                chatMessages.map((msg, index) => (
                  <div key={index} 
                    className={`max-w-[75%] rounded-2xl px-4 py-2 mb-2 ${
                      msg.type === 'server' 
                        ? 'bg-white text-gray-800 ml-0' 
                        : 'bg-blue-500 text-white ml-auto'
                    }`}
                  >
                    {msg.content}
                  </div>
                ))
              )}
            </div>

            <h3 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <i className="fas fa-terminal"></i>
              Logs del servidor
            </h3>
            <div 
              ref={logsRef}
              className="bg-gray-900 text-green-400 rounded-xl p-4 h-72 overflow-y-auto font-mono text-sm"
            >
              {logs.length === 0 ? (
                <span className="text-gray-500">No hay logs disponibles</span>
              ) : (
                logs.map((log, index) => (
                  <div key={index} className="whitespace-pre-wrap">{log}</div>
                ))
              )}
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>